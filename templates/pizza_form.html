{% extends "base.html" %}
{% block title %}
    {% if is_edit %}Edit{% else %}New{% endif %} Pizza Order - Pizza Delivery System
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md">
    <h2 class="text-2xl font-bold mb-6">
        {% if is_edit %}Edit{% else %}New{% endif %} Pizza Order
    </h2>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="{% if category == 'error' %}bg-red-100 text-red-700{% elif category == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-700{% endif %} px-4 py-3 rounded mb-4" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <form id="pizza-form" {% if not is_edit %}method="POST" action="{{ url_for('pizza') }}"{% else %}data-pizza-id="{{ pizza_id }}"{% endif %} class="space-y-6">
        {{ form.hidden_tag() }}
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% for field in [form.type, form.crust, form.size, form.quantity, form.price_per, form.order_date] %}
            <div>
                {{ field.label(class="block text-gray-700 text-sm font-bold mb-2") }}
                {{ field(class=field.render_kw.class ~ " w-full") }}
                {% if field.errors %}
                    <div class="text-red-500 text-xs mt-1">
                        {% for error in field.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
                {% if field.id == 'quantity' %}<div id="quantity-error" class="hidden text-red-500 text-sm mt-1"></div>{% endif %}
            </div>
            {% endfor %}
        </div>
        
        <!-- Order Summary -->
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mt-6">
            <h3 class="text-lg font-semibold text-blue-800 mb-2">Order Summary</h3>
            <div class="grid grid-cols-2 gap-2">
                <div class="text-gray-600">Subtotal:</div>
                <div id="subtotal" class="text-right font-medium">$0.00</div>
                
                <div class="text-gray-600">Delivery (10%):</div>
                <div id="delivery" class="text-right font-medium">$0.00</div>
                
                <div class="text-gray-800 font-bold border-t pt-2 mt-1">Total:</div>
                <div id="total" class="text-right font-bold text-blue-700 border-t pt-2 mt-1">$0.00</div>
            </div>
        </div>
        
        <div class="flex justify-end space-x-4 mt-6">
            <a href="{{ url_for('index') }}" class="py-2 px-6 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                Cancel
            </a>
            {% if is_edit %}
            <button type="button" id="update-button" class="py-2 px-6 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                Update Order
            </button>
            {% else %}
            <button type="submit" class="py-2 px-6 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                Submit Order
            </button>
            {% endif %}
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elements
        const form = document.getElementById('pizza-form');
        const quantityInput = document.getElementById('quantity');
        const priceInput = document.getElementById('price_per');
        const errorDiv = document.getElementById('quantity-error');
        const subtotalEl = document.getElementById('subtotal');
        const deliveryEl = document.getElementById('delivery');
        const totalEl = document.getElementById('total');
        
        // Validation function
        function validateQuantity() {
            let qty = 0;
            
            // Only try to parse if there's a value
            if (quantityInput.value.trim() !== '') {
                qty = parseInt(quantityInput.value);
            }
            
            // Reset error state
            errorDiv.classList.add('hidden');
            quantityInput.classList.remove('border-red-500');
            
            // Validate quantity limits
            if (qty > 10) {
                errorDiv.textContent = 'Maximum quantity allowed is 10 pizzas per order.';
                errorDiv.classList.remove('hidden');
                quantityInput.classList.add('border-red-500');
                quantityInput.value = 10;
                calculatePrices();
                return false;
            } else if (qty < 1 && quantityInput.value.trim() !== '') {
                errorDiv.textContent = 'Minimum quantity is 1 pizza.';
                errorDiv.classList.remove('hidden');
                quantityInput.classList.add('border-red-500');
                quantityInput.value = 1;
                calculatePrices();
                return false;
            }
            
            calculatePrices();
            return true;
        }
        
        // Calculate and update prices
        function calculatePrices() {
            // Get quantity and price, defaulting to 0 if invalid or empty
            let qty = 0;
            let price = 0;
            
            if (quantityInput.value.trim() !== '') {
                qty = parseInt(quantityInput.value) || 0;
            }
            
            if (priceInput.value.trim() !== '') {
                price = parseFloat(priceInput.value) || 0;
            }
            
            // Calculate values
            const subtotal = qty * price;
            const delivery = subtotal * 0.1;
            const total = subtotal + delivery;
            
            // Update display with properly formatted values
            subtotalEl.textContent = '$' + subtotal.toFixed(2);
            deliveryEl.textContent = '$' + delivery.toFixed(2);
            totalEl.textContent = '$' + total.toFixed(2);
        }
        
        // Event listeners
        quantityInput.addEventListener('input', validateQuantity);
        priceInput.addEventListener('input', calculatePrices);
        form.addEventListener('submit', function(e) {
            if (!validateQuantity()) {
                e.preventDefault();
            }
        });
        
        // Initial calculation
        calculatePrices();

        {% if is_edit %}
        // Edit functionality
        const updateBtn = document.getElementById('update-button');
        
        updateBtn.addEventListener('click', function() {
            if (!validateQuantity()) return;
            
            const formData = new FormData(form);
            const pizzaId = form.dataset.pizzaId;
            
            // Format date
            const dateObj = new Date(formData.get('order_date'));
            const formattedDate = `${dateObj.getFullYear()}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${String(dateObj.getDate()).padStart(2, '0')}`;
            
            // Create order data
            const orderData = {
                id: parseInt(pizzaId),
                type: formData.get('type'),
                crust: formData.get('crust'),
                size: formData.get('size'),
                quantity: parseInt(formData.get('quantity')),
                price_per: parseFloat(formData.get('price_per')),
                order_date: formattedDate
            };
            
            // Show loading state
            updateBtn.disabled = true;
            updateBtn.innerHTML = 'Updating...';
            
            // Send request
            fetch(`/pizza/${pizzaId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(orderData)
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/';
                } else {
                    updateBtn.disabled = false;
                    updateBtn.innerHTML = 'Update Order';
                    alert('Failed to update order. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                updateBtn.disabled = false;
                updateBtn.innerHTML = 'Update Order';
                alert('An error occurred. Please try again.');
            });
        });
        {% endif %}
    });
</script>
{% endblock %}